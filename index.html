<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Stores Map</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { margin: 0; padding: 0; font-family: sans-serif; overflow: hidden; background: #f8f9fa; }
        #map { height: 100vh; width: 100%; z-index: 1; }
        
        .top-bar {
            position: absolute; top: 0; left: 0; width: 100%; z-index: 1000; padding: 10px;
            background: linear-gradient(to bottom, rgba(255,255,255,0.9), rgba(255,255,255,0)); pointer-events: none;
        }
        
        .search-row {
            display: flex; gap: 8px; max-width: 400px; margin: 0 auto; pointer-events: auto;
        }
        
        .search-container {
            flex: 1; background: #fff; border-radius: 4px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.15);
            display: flex; align-items: center; padding: 8px 12px;
        }
        .search-container input {
            border: none; outline: none; width: 100%; font-size: 16px; margin-left: 10px;
        }
        
        .btn-filter {
            width: 42px; height: 42px; border: none; border-radius: 4px;
            background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.15);
            cursor: pointer; color: #5f6368; font-size: 16px;
        }
        .btn-filter.active { color: #1a73e8; background: #e8f0fe; }

        .filter-panel {
            display: none; width: 100%; max-width: 400px; margin: 8px auto;
            background: #fff; border-radius: 4px; padding: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15); pointer-events: auto;
        }
        .filter-panel.open { display: block; }
        
        .filter-group { margin-bottom: 12px; }
        .filter-group label { display: block; font-size: 13px; color: #5f6368; margin-bottom: 6px; font-weight: 600; }
        
        .chips { display: flex; gap: 6px; }
        .chip {
            padding: 5px 12px; background: #f1f3f4; border-radius: 16px; font-size: 13px;
            cursor: pointer; border: 1px solid transparent; color: #3c4043;
        }
        .chip.selected {
            background: #e8f0fe; color: #1967d2; border-color: #1967d2;
        }
        
        .btn-apply {
            width: 100%; background: #1a73e8; color: #fff; border: none;
            padding: 8px; border-radius: 4px; cursor: pointer; margin-top: 5px; font-weight: 600;
        }

        .category-bar {
            pointer-events: auto; display: flex; gap: 8px; overflow-x: auto; 
            padding: 10px 0; max-width: 600px; margin: 0 auto;
        }
        .category-bar::-webkit-scrollbar { display: none; }
        
        .cat-chip {
            background: #fff; padding: 6px 14px; border-radius: 20px; 
            font-size: 14px; color: #555; cursor: pointer; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); white-space: nowrap; border: 1px solid #ddd;
        }
        .cat-chip.active { background: #333; color: #fff; border-color: #333; }

        #info-card {
            position: absolute; bottom: -600px; left: 0; width: 100%;
            background: #fff; border-radius: 12px 12px 0 0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.15);
            z-index: 1001; padding: 20px; box-sizing: border-box;
            transition: bottom 0.3s;
        }
        #info-card.show { bottom: 0; }
        
        .card-title { margin: 0 0 6px 0; font-size: 18px; color: #202124; }
        
        .card-meta { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; }
        .meta-badge { font-size: 12px; padding: 2px 6px; border-radius: 4px; background: #f1f3f4; color: #5f6368; }
        .meta-rating { background: #fff8e1; color: #b06000; display: flex; align-items: center; gap: 4px; }
        .meta-price { font-weight: bold; color: #333; }

        .tags-row { display: flex; flex-wrap: wrap; gap: 4px; margin-bottom: 12px; }
        .mini-tag { font-size: 11px; color: #5f6368; background: #f1f3f4; padding: 2px 8px; border-radius: 10px; }

        .info-line { display: flex; align-items: start; margin-bottom: 8px; color: #5f6368; font-size: 14px; }
        .info-line i { width: 20px; margin-top: 3px; color: #70757a; }

        .actions { display: flex; gap: 10px; margin-top: 15px; }
        .btn-action {
            flex: 1; padding: 10px; border: none; border-radius: 4px; 
            font-weight: 500; cursor: pointer; text-align: center; text-decoration: none;
        }
        .btn-primary { background: #1a73e8; color: #fff; }
        .btn-secondary { background: #f1f3f4; color: #3c4043; }

        @media (min-width: 768px) {
            #info-card { width: 360px; left: 20px; bottom: 20px; border-radius: 8px; transform: translateY(120%); }
            #info-card.show { bottom: 20px; transform: translateY(0); }
            .category-bar { justify-content: center; }
        }
    </style>
</head>
<body>

    <div class="top-bar">
        <div class="search-row">
            <div class="search-container">
                <i class="fas fa-search" style="color:#5f6368"></i>
                <input type="text" id="search-input" placeholder="Search...">
            </div>
            <button id="filter-toggle" class="btn-filter">
                <i class="fas fa-sliders-h"></i>
            </button>
        </div>

        <div id="filter-panel" class="filter-panel">
            <div class="filter-group">
                <label>Rating</label>
                <div class="chips">
                    <div class="chip selected" data-type="rating" data-val="0">All</div>
                    <div class="chip" data-type="rating" data-val="3.5">3.5+</div>
                    <div class="chip" data-type="rating" data-val="4.0">4.0+</div>
                    <div class="chip" data-type="rating" data-val="4.5">4.5+</div>
                </div>
            </div>
            <div class="filter-group">
                <label>Price</label>
                <div class="chips">
                    <div class="chip selected" data-type="price" data-val="all">All</div>
                    <div class="chip" data-type="price" data-val="1">$</div>
                    <div class="chip" data-type="price" data-val="2">$$</div>
                    <div class="chip" data-type="price" data-val="3">$$$</div>
                    <div class="chip" data-type="price" data-val="4">$$$$</div>
                    <div class="chip" data-type="price" data-val="5">$$$$$</div>
                </div>
            </div>
            <button class="btn-apply" onclick="applyFilters()">Apply Filters</button>
        </div>

        <div class="category-bar" id="category-list"></div>
    </div>

    <div id="map"></div>

    <div id="info-card">
        <h2 class="card-title" id="store-name">Store Name</h2>
        <div class="card-meta">
            <span class="meta-badge" id="store-cat">Category</span>
            <span class="meta-badge meta-rating" id="rating-badge" style="display:none">
                <i class="fas fa-star"></i> <span id="store-rating"></span>
            </span>
            <span class="meta-badge meta-price" id="store-price"></span>
        </div>
        
        <div class="tags-row" id="tags-box"></div>

        <div id="store-review" style="margin-bottom: 12px; font-size: 13px; color: #555; line-height: 1.5; max-height: 100px; overflow-y: auto; padding: 8px; background: #f8f9fa; border-radius: 6px;"></div>

        <div class="info-line">
            <i class="fas fa-map-marker-alt"></i>
            <span id="store-addr">Address</span>
        </div>
        <div class="info-line">
            <i class="fas fa-phone"></i>
            <span id="store-phone">Phone</span>
        </div>

        <div class="actions">
            <a id="nav-btn" href="#" target="_blank" class="btn-action btn-primary">
                <i class="fas fa-location-arrow"></i> Navigate
            </a>
            <button class="btn-action btn-secondary" onclick="closeCard()">Close</button>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <script>
        const map = L.map('map', {zoomControl: false}).setView([25.0478, 121.5170], 14);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; CARTO'
        }).addTo(map);

        const markersLayer = L.markerClusterGroup({
            disableClusteringAtZoom: 16,
            maxClusterRadius: 50,
            showCoverageOnHover: false
        });
        map.addLayer(markersLayer);

        let currentCat = "All";
        let searchTimer;
        let activeFilters = { rating: 0, price: 'all' };
        let priceThresholds = {};

        const colors = ['#F44336', '#E91E63', '#9C27B0', '#673AB7', '#3F51B5', '#2196F3', '#03A9F4', '#00BCD4', '#009688', '#4CAF50', '#FF9800', '#FF5722'];
        function getColor(str) {
            if(!str) return '#333';
            let hash = 0;
            for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
            return colors[Math.abs(hash) % colors.length];
        }

        async function init() {
            try {
                // Fetch config first
                const confRes = await fetch('/api/config');
                const conf = await confRes.json();
                priceThresholds = conf.price_thresholds;

                const res = await fetch('/api/categories');
                const cats = await res.json();
                const container = document.getElementById('category-list');
                
                cats.forEach(c => {
                    const el = document.createElement('div');
                    el.className = `cat-chip ${c === 'All' ? 'active' : ''}`;
                    el.innerText = c;
                    el.onclick = () => {
                        document.querySelectorAll('.cat-chip').forEach(x => x.classList.remove('active'));
                        el.classList.add('active');
                        currentCat = c;
                        loadData();
                    };
                    container.appendChild(el);
                });
            } catch(e) { console.error(e); }

            map.on('moveend', () => loadData(false));
            map.on('click', closeCard);
            document.getElementById('search-input').addEventListener('input', () => {
                clearTimeout(searchTimer);
                searchTimer = setTimeout(() => loadData(true), 600);
            });

            document.getElementById('filter-toggle').onclick = () => {
                document.getElementById('filter-panel').classList.toggle('open');
                document.getElementById('filter-toggle').classList.toggle('active');
            };

            document.querySelectorAll('.chip').forEach(chip => {
                chip.onclick = function() {
                    const type = this.dataset.type;
                    document.querySelectorAll(`.chip[data-type="${type}"]`).forEach(c => c.classList.remove('selected'));
                    this.classList.add('selected');
                    activeFilters[type] = this.dataset.val;
                };
            });

            loadData();
        }

        window.applyFilters = function() {
            document.getElementById('filter-panel').classList.remove('open');
            document.getElementById('filter-toggle').classList.remove('active');
            loadData();
        }

        async function loadData(fit = false) {
            const b = map.getBounds();
            const q = document.getElementById('search-input').value;
            let url = `/api/stores?min_lat=${b.getSouth()}&max_lat=${b.getNorth()}&min_lng=${b.getWest()}&max_lng=${b.getEast()}`;
            
            url += `&category=${encodeURIComponent(currentCat)}`;
            if(q) url += `&keyword=${encodeURIComponent(q)}`;
            if(activeFilters.rating > 0) url += `&min_rating=${activeFilters.rating}`;
            if(activeFilters.price !== 'all') url += `&price_level=${activeFilters.price}`;

            try {
                const res = await fetch(url);
                const json = await res.json();
                markersLayer.clearLayers();
                
                const list = [];
                json.data.forEach(d => {
                    if(d.lat && d.lng) {
                        const m = L.circleMarker([d.lat, d.lng], {
                            radius: 7, fillColor: getColor(d.ind),
                            color: '#fff', weight: 1.5, fillOpacity: 0.9
                        });
                        m.on('click', (e) => {
                            L.DomEvent.stopPropagation(e);
                            showCard(d);
                        });
                        list.push(m);
                    }
                });
                markersLayer.addLayers(list);
                if(fit && q && list.length) map.fitBounds(markersLayer.getBounds());
            } catch(e) { console.error(e); }
        }

        function showCard(d) {
            document.getElementById('store-name').innerText = d.name;
            document.getElementById('store-cat').innerText = d.ind;
            document.getElementById('store-addr').innerText = d.address;
            document.getElementById('store-phone').innerText = d.phone || 'N/A';
            
            const ratingBadge = document.getElementById('rating-badge');
            if(d.rating) {
                document.getElementById('store-rating').innerText = d.rating;
                ratingBadge.style.display = 'flex';
            } else {
                ratingBadge.style.display = 'none';
            }

            const priceEl = document.getElementById('store-price');
            priceEl.innerText = "";
            if(d.price_level) {
                let p = parseInt(d.price_level);
                if (!isNaN(p)) {
                    // 若數值大於 5，則視為真實價格，並依據設定檔動態轉換等級
                    if (p > 5) {
                        const ind = d.ind || 'default';
                        // 取得該行業的 thresholds，若無則用 default
                        const th = priceThresholds[ind] || priceThresholds['default'] || [1500, 3000, 5000, 8000];
                        
                        if (p < th[0]) p = 1;
                        else if (p < th[1]) p = 2;
                        else if (p < th[2]) p = 3;
                        else if (p < th[3]) p = 4;
                        else p = 5;
                    }
                    // 限制最大顯示 5 個 $
                    p = Math.min(p, 5);
                    priceEl.innerText = "$".repeat(p);
                }
            }

            const tagBox = document.getElementById('tags-box');
            tagBox.innerHTML = "";
            if(d.hidden_tags) {
                const tags = d.hidden_tags.split(" ").slice(0, 3);
                tags.forEach(t => {
                    if(t) tagBox.innerHTML += `<span class="mini-tag">#${t}</span>`;
                });
            }

            const reviewEl = document.getElementById('store-review');
            if(d.review_summary) {
                reviewEl.innerText = d.review_summary;
                reviewEl.style.display = 'block';
            } else {
                reviewEl.style.display = 'none';
            }

            const nav = document.getElementById('nav-btn');
            if(d.lat && d.lng) nav.href = `https://www.google.com/maps/dir/?api=1&destination=${d.lat},${d.lng}`;
            else nav.href = "#";

            document.getElementById('info-card').classList.add('show');
        }

        window.closeCard = function() {
            document.getElementById('info-card').classList.remove('show');
        }

        init();
    </script>
</body>
</html>